sudo: required
language: node_js
node_js:
  - node

services:
  - docker

env:
  global:
    # Both docker and github repo names are case sensitive
    - DOCKER_REPO=brewblox/brewblox-ui
    - GITHUB_REPO=BrewBlox/brewblox-ui

install:
  - npm ci

script:
  - npm run lint
  - npm run test
  - npm run build

before_deploy:
  cp -r dist/ docker/;
  docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD};
  docker run --rm --privileged multiarch/qemu-user-static:register --reset;
  export BRANCH_TAG=$(echo "${TRAVIS_BRANCH}" | tr '/' '-' | tr '[:upper:]' '[:lower:]');
  export GIT_TAG=$(git describe --tags);

deploy:
  # Deploy AMD "newest-tag" and version tag to Docker Hub on tagged commits
  - provider: script
    script:
      docker build
        --no-cache
        -t ${DOCKER_REPO}:newest-tag
        -t ${DOCKER_REPO}:${GIT_TAG}
        -f docker/amd/Dockerfile
        docker;
      docker push ${DOCKER_REPO}:newest-tag;
      docker push ${DOCKER_REPO}:${GIT_TAG};
    skip_cleanup: true
    on:
      tags: true

  # Deploy ARM "rpi-newest-tag" and version tag to Docker Hub on tagged commits
  - provider: script
    script:
      docker build
        --no-cache
        -t ${DOCKER_REPO}:rpi-newest-tag
        -t ${DOCKER_REPO}:rpi-${GIT_TAG}
        -f docker/arm/Dockerfile
        docker;
      docker push ${DOCKER_REPO}:rpi-newest-tag;
      docker push ${DOCKER_REPO}:rpi-${GIT_TAG};
    skip_cleanup: true
    on:
      tags: true

  # Deploy AMD branch to Docker Hub on any push to an upstream development branch
  - provider: script
    script:
      docker build
        --no-cache
        -t ${DOCKER_REPO}:${BRANCH_TAG}
        -f docker/amd/Dockerfile
        docker;
      docker push ${DOCKER_REPO}:${BRANCH_TAG};
    skip_cleanup: true
    on:
      tags: false
      repo: ${GITHUB_REPO}
      all_branches: true

  # Deploy ARM branch to Docker Hub on any push to an upstream development branch
  - provider: script
    script:
      docker build
        --no-cache
        -t ${DOCKER_REPO}:rpi-${BRANCH_TAG}
        -f docker/arm/Dockerfile
        docker;
      docker push ${DOCKER_REPO}:rpi-${BRANCH_TAG};
    skip_cleanup: true
    on:
      tags: false
      repo: ${GITHUB_REPO}
      all_branches: true
